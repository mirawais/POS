generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id              String           @id @default(cuid())
  name            String
  logoUrl         String?          @map("logo_url")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  users           User[]
  products        Product[]
  rawMaterials    RawMaterial[]
  productMaterials ProductRawMaterial[]
  sales           Sale[]
  saleItems       SaleItem[]
  heldBills       HeldBill[]
  discounts       Discount[]
  taxSettings     TaxSetting[]
  invoiceSettings InvoiceSetting?
  categories      Category[]
  coupons         Coupon[]
  discountRules   DiscountRule[]
}

enum Role {
  ADMIN
  CASHIER
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      Role     @default(CASHIER)
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])
  sales     Sale[]
  heldBills HeldBill[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

enum ProductType {
  SIMPLE
  VARIANT
  COMPOSITE
}

enum CouponType {
  PERCENT
  AMOUNT
}

enum DiscountScope {
  ITEM
  CART
}

model Product {
  id           String       @id @default(cuid())
  clientId     String       @map("client_id")
  client       Client       @relation(fields: [clientId], references: [id])
  name         String
  sku          String       @unique
  type         ProductType  @default(SIMPLE)
  price        Decimal      @db.Decimal(10,2)
  costPrice    Decimal?     @db.Decimal(10,2) @map("cost_price")
  stock        Int          @default(0)
  lowStockAt   Int?         @map("low_stock_at")
  isActive     Boolean      @default(true) @map("is_active")
  categoryId   String?      @map("category_id")
  category     Category?    @relation(fields: [categoryId], references: [id])
  defaultTaxId String?      @map("default_tax_id")
  defaultTax   TaxSetting?  @relation(fields: [defaultTaxId], references: [id])
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  materials    ProductRawMaterial[]
  variants     ProductVariant[]
  saleItems    SaleItem[]
}

model RawMaterial {
  id         String    @id @default(cuid())
  clientId   String    @map("client_id")
  client     Client    @relation(fields: [clientId], references: [id])
  name       String
  sku        String    @unique
  unit       String?   @default("unit")
  stock      Int       @default(0)
  lowStockAt Int?      @map("low_stock_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  usedIn     ProductRawMaterial[]
}

model ProductRawMaterial {
  id             String       @id @default(cuid())
  clientId       String       @map("client_id")
  client         Client       @relation(fields: [clientId], references: [id])
  productId      String       @map("product_id")
  product        Product      @relation(fields: [productId], references: [id])
  rawMaterialId  String       @map("raw_material_id")
  rawMaterial    RawMaterial  @relation(fields: [rawMaterialId], references: [id])
  quantity       Decimal      @db.Decimal(10,3) @default(1)
  unit           String?      @default("unit")
}

model Discount {
  id         String    @id @default(cuid())
  clientId   String    @map("client_id")
  client     Client    @relation(fields: [clientId], references: [id])
  name       String
  isPerItem  Boolean   @default(true) @map("is_per_item")
  percent    Decimal?  @db.Decimal(5,2)
  amount     Decimal?  @db.Decimal(10,2)
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
}

model TaxSetting {
  id         String    @id @default(cuid())
  clientId   String    @map("client_id")
  client     Client    @relation(fields: [clientId], references: [id])
  name       String
  percent    Decimal   @db.Decimal(5,2)
  isDefault  Boolean   @default(false) @map("is_default")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  products   Product[]
}

model InvoiceSetting {
  id             String   @id @default(cuid())
  clientId       String   @unique @map("client_id")
  client         Client   @relation(fields: [clientId], references: [id])
  logoUrl        String?  @map("logo_url")
  headerText     String?  @map("header_text")
  footerText     String?  @map("footer_text")
  showTax        Boolean  @default(true) @map("show_tax")
  showDiscount   Boolean  @default(true) @map("show_discount")
  showCashier    Boolean  @default(true) @map("show_cashier")
  showCustomer   Boolean  @default(true) @map("show_customer")
}

model Sale {
  id          String    @id @default(cuid())
  clientId    String    @map("client_id")
  client      Client    @relation(fields: [clientId], references: [id])
  cashierId   String    @map("cashier_id")
  cashier     User      @relation(fields: [cashierId], references: [id])
  subtotal    Decimal   @db.Decimal(10,2)
  discount    Decimal   @default(0) @db.Decimal(10,2)
  couponCode  String?   @map("coupon_code")
  couponValue Decimal?  @db.Decimal(10,2) @map("coupon_value")
  taxPercent  Decimal?  @db.Decimal(5,2)  @map("tax_percent")
  tax         Decimal   @default(0) @db.Decimal(10,2)
  total       Decimal   @db.Decimal(10,2)
  createdAt   DateTime  @default(now()) @map("created_at")
  items       SaleItem[]
}

model SaleItem {
  id         String   @id @default(cuid())
  clientId   String   @map("client_id")
  client     Client   @relation(fields: [clientId], references: [id])
  saleId     String   @map("sale_id")
  sale       Sale     @relation(fields: [saleId], references: [id])
  productId  String   @map("product_id")
  product    Product  @relation(fields: [productId], references: [id])
  variantId  String?  @map("variant_id")
  variant    ProductVariant? @relation(fields: [variantId], references: [id])
  quantity   Int
  price      Decimal  @db.Decimal(10,2)
  discount   Decimal  @default(0) @db.Decimal(10,2)
  tax        Decimal  @default(0) @db.Decimal(10,2)
  total      Decimal  @db.Decimal(10,2)
}

model HeldBill {
  id         String   @id @default(cuid())
  clientId   String   @map("client_id")
  client     Client   @relation(fields: [clientId], references: [id])
  cashierId  String   @map("cashier_id")
  cashier    User     @relation(fields: [cashierId], references: [id])
  data       Json
  createdAt  DateTime @default(now()) @map("created_at")
}

model Category {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])
  name      String
  isDefault Boolean  @default(false) @map("is_default")
  products  Product[]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model Coupon {
  id        String      @id @default(cuid())
  clientId  String      @map("client_id")
  client    Client      @relation(fields: [clientId], references: [id])
  code      String      @unique
  type      CouponType
  value     Decimal     @db.Decimal(10,2)
  isActive  Boolean     @default(true) @map("is_active")
  startsAt  DateTime?
  endsAt    DateTime?
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
}

model DiscountRule {
  id        String         @id @default(cuid())
  clientId  String         @map("client_id")
  client    Client         @relation(fields: [clientId], references: [id])
  name      String
  scope     DiscountScope
  type      CouponType
  value     Decimal        @db.Decimal(10,2)
  isActive  Boolean        @default(true) @map("is_active")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
}

model ProductVariant {
  id            String    @id @default(cuid())
  productId     String    @map("product_id")
  product       Product   @relation(fields: [productId], references: [id])
  name          String?
  sku           String?
  price         Decimal   @db.Decimal(10,2)
  costPrice     Decimal?  @db.Decimal(10,2) @map("cost_price")
  stock         Int       @default(0)
  lowStockAt    Int?      @map("low_stock_at")
  attributes    Json?     // Flexible attributes: { color, size, weight, custom fields }
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  saleItems     SaleItem[]
}

