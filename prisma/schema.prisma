generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id                String               @id @default(cuid())
  name              String
  logoUrl           String?              @map("logo_url")
  companyName       String?              @map("company_name")
  contactNumber     String?              @map("contact_number")
  techContact       String?              @map("tech_contact")
  email             String?
  address           String?
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  isActive          Boolean              @default(true) @map("is_active")
  activeDate        DateTime             @default(now()) @map("active_date")
  inactiveDate      DateTime?            @map("inactive_date")
  users             User[]
  products          Product[]
  rawMaterials      RawMaterial[]
  productMaterials  ProductRawMaterial[]
  sales             Sale[]
  saleItems         SaleItem[]
  heldBills         HeldBill[]
  discounts         Discount[]
  taxSettings       TaxSetting[]
  invoiceSettings   InvoiceSetting?
  categories        Category[]
  coupons           Coupon[]
  discountRules     DiscountRule[]
  refunds           Refund[]
  refundItems       RefundItem[]
  variantAttributes VariantAttribute[]
  fbrSetting        FBRSetting?
}

enum Role {
  SUPER_ADMIN
  ADMIN
  CASHIER
  MANAGER
}

model User {
  id          String     @id @default(cuid())
  email       String     @unique
  name        String?
  password    String
  role        Role       @default(CASHIER)
  permissions Json?      @map("permissions") // Custom permissions for MANAGER role
  clientId    String?    @map("client_id")
  client      Client?    @relation(fields: [clientId], references: [id])
  sales       Sale[]
  heldBills   HeldBill[]
  refunds     Refund[]
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
}

enum ProductType {
  SIMPLE
  VARIANT
  COMPOSITE
}

enum CouponType {
  PERCENT
  AMOUNT
}

enum DiscountScope {
  ITEM
  CART
}

// Product Model Update
model Product {
  id           String               @id @default(cuid())
  clientId     String               @map("client_id")
  client       Client               @relation(fields: [clientId], references: [id])
  name         String
  sku          String
  type         ProductType          @default(SIMPLE)
  price        Decimal              @db.Decimal(10, 2)
  costPrice    Decimal?             @map("cost_price") @db.Decimal(10, 2)
  stock        Int                  @default(0)
  isUnlimited  Boolean              @default(false) @map("is_unlimited")
  lowStockAt   Int?                 @map("low_stock_at")
  isActive     Boolean              @default(true) @map("is_active")
  isFavorite   Boolean              @default(false) @map("is_favorite")
  categoryId   String?              @map("category_id")
  category     Category?            @relation(fields: [categoryId], references: [id])
  defaultTaxId String?              @map("default_tax_id")
  defaultTax   TaxSetting?          @relation(fields: [defaultTaxId], references: [id])
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  materials    ProductRawMaterial[]
  variants     ProductVariant[]
  saleItems    SaleItem[]
  refundItems  RefundItem[]

  @@unique([clientId, sku])
}

model RawMaterial {
  id          String               @id @default(cuid())
  clientId    String               @map("client_id")
  client      Client               @relation(fields: [clientId], references: [id])
  name        String
  sku         String
  unit        String?              @default("unit")
  stock       Int                  @default(0)
  lowStockAt  Int?                 @map("low_stock_at")
  isUnlimited Boolean              @default(false) @map("is_unlimited")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")
  usedIn      ProductRawMaterial[]

  @@unique([clientId, sku])
}

// ProductRawMaterial and other missing models restored
model ProductRawMaterial {
  id            String      @id @default(cuid())
  clientId      String      @map("client_id")
  client        Client      @relation(fields: [clientId], references: [id])
  productId     String      @map("product_id")
  product       Product     @relation(fields: [productId], references: [id])
  rawMaterialId String      @map("raw_material_id")
  rawMaterial   RawMaterial @relation(fields: [rawMaterialId], references: [id])
  quantity      Decimal     @default(1) @db.Decimal(10, 3)
  unit          String?     @default("unit")
}

model Discount {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])
  name      String
  isPerItem Boolean  @default(true) @map("is_per_item")
  percent   Decimal? @db.Decimal(5, 2)
  amount    Decimal? @db.Decimal(10, 2)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}

model TaxSetting {
  id        String    @id @default(cuid())
  clientId  String    @map("client_id")
  client    Client    @relation(fields: [clientId], references: [id])
  name      String
  percent   Decimal   @db.Decimal(5, 2)
  isDefault Boolean   @default(false) @map("is_default")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  products  Product[]
}

model InvoiceSetting {
  id                String  @id @default(cuid())
  clientId          String  @unique @map("client_id")
  client            Client  @relation(fields: [clientId], references: [id])
  logoUrl           String? @map("logo_url")
  headerText        String? @map("header_text")
  footerText        String? @map("footer_text")
  showTax           Boolean @default(true) @map("show_tax")
  showDiscount      Boolean @default(true) @map("show_discount")
  showCashier       Boolean @default(true) @map("show_cashier")
  showCustomer      Boolean @default(true) @map("show_customer")
  customFields      Json?   @map("custom_fields") // Array of {label, value, sortOrder}
  taxMode           String  @default("EXCLUSIVE") @map("tax_mode") // EXCLUSIVE or INCLUSIVE
  fontSize          Int     @default(12) @map("font_size")
  showPriceDecimals Boolean @default(true) @map("show_price_decimals")
}

model FBRSetting {
  id          String   @id @default(cuid())
  clientId    String   @unique @map("client_id")
  client      Client   @relation(fields: [clientId], references: [id])
  url         String   @default("https://esp.fbr.gov.pk:8244/FBR/v1/api/Live/PostData") @map("url")
  bearerToken String   @map("bearer_token")
  posId       String   @map("pos_id")
  usin        String   @default("USIN0") @map("usin")
  paymentMode Int      @default(2) @map("payment_mode") // 1 = Cash, 2 = Card
  invoiceType Int      @default(1) @map("invoice_type")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
}

model Sale {
  id            String     @id @default(cuid())
  orderId       String     @unique @map("order_id") // Unique order ID for each transaction
  clientId      String     @map("client_id")
  client        Client     @relation(fields: [clientId], references: [id])
  cashierId     String     @map("cashier_id")
  cashier       User       @relation(fields: [cashierId], references: [id])
  subtotal      Decimal    @db.Decimal(10, 2)
  discount      Decimal    @default(0) @db.Decimal(10, 2)
  couponCode    String?    @map("coupon_code")
  couponValue   Decimal?   @map("coupon_value") @db.Decimal(10, 2)
  taxPercent    Decimal?   @map("tax_percent") @db.Decimal(5, 2)
  tax           Decimal    @default(0) @db.Decimal(10, 2)
  total         Decimal    @db.Decimal(10, 2)
  type          String     @default("SALE") @map("type") // SALE, EXCHANGE, REFUND
  paymentMethod String?    @default("CASH") @map("payment_method") // CASH, CARD
  fbrInvoiceId  String?    @map("fbr_invoice_id") // FBR Invoice ID / USIN
  createdAt     DateTime   @default(now()) @map("created_at")
  customerName  String?    @map("customer_name")
  customerPhone String?    @map("customer_phone")
  items         SaleItem[]
  refunds       Refund[]
}

model SaleItem {
  id               String          @id @default(cuid())
  clientId         String          @map("client_id")
  client           Client          @relation(fields: [clientId], references: [id])
  saleId           String          @map("sale_id")
  sale             Sale            @relation(fields: [saleId], references: [id])
  productId        String          @map("product_id")
  product          Product         @relation(fields: [productId], references: [id])
  variantId        String?         @map("variant_id")
  variant          ProductVariant? @relation(fields: [variantId], references: [id])
  quantity         Int
  returnedQuantity Int             @default(0) @map("returned_quantity") // Track returned items
  price            Decimal         @db.Decimal(10, 2)
  discount         Decimal         @default(0) @db.Decimal(10, 2)
  tax              Decimal         @default(0) @db.Decimal(10, 2)
  total            Decimal         @db.Decimal(10, 2)
  refundItems      RefundItem[]
}

model HeldBill {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])
  cashierId String   @map("cashier_id")
  cashier   User     @relation(fields: [cashierId], references: [id])
  data      Json
  createdAt DateTime @default(now()) @map("created_at")
}

model Category {
  id        String    @id @default(cuid())
  clientId  String    @map("client_id")
  client    Client    @relation(fields: [clientId], references: [id])
  name      String
  isDefault Boolean   @default(false) @map("is_default")
  products  Product[]
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
}

model Coupon {
  id        String     @id @default(cuid())
  clientId  String     @map("client_id")
  client    Client     @relation(fields: [clientId], references: [id])
  code      String
  type      CouponType
  value     Decimal    @db.Decimal(10, 2)
  isActive  Boolean    @default(true) @map("is_active")
  startsAt  DateTime?
  endsAt    DateTime?
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  @@unique([clientId, code])
}

model DiscountRule {
  id        String        @id @default(cuid())
  clientId  String        @map("client_id")
  client    Client        @relation(fields: [clientId], references: [id])
  name      String
  scope     DiscountScope
  type      CouponType
  value     Decimal       @db.Decimal(10, 2)
  isActive  Boolean       @default(true) @map("is_active")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
}

model ProductVariant {
  id          String       @id @default(cuid())
  productId   String       @map("product_id")
  product     Product      @relation(fields: [productId], references: [id])
  name        String?
  sku         String?
  price       Decimal      @db.Decimal(10, 2)
  costPrice   Decimal?     @map("cost_price") @db.Decimal(10, 2)
  stock       Int          @default(0)
  lowStockAt  Int?         @map("low_stock_at")
  attributes  Json? // Flexible attributes: { color, size, weight, custom fields }
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  saleItems   SaleItem[]
  refundItems RefundItem[]
}

model Refund {
  id        String       @id @default(cuid())
  saleId    String       @map("sale_id")
  sale      Sale         @relation(fields: [saleId], references: [id])
  clientId  String       @map("client_id")
  client    Client       @relation(fields: [clientId], references: [id])
  cashierId String       @map("cashier_id")
  cashier   User         @relation(fields: [cashierId], references: [id])
  refundId  String       @unique @map("refund_id") // Unique refund ID
  total     Decimal      @db.Decimal(10, 2)
  reason    String? // Optional refund reason
  createdAt DateTime     @default(now()) @map("created_at")
  items     RefundItem[]
}

model RefundItem {
  id           String          @id @default(cuid())
  refundId     String          @map("refund_id")
  refund       Refund          @relation(fields: [refundId], references: [id])
  clientId     String          @map("client_id")
  client       Client          @relation(fields: [clientId], references: [id])
  saleItemId   String          @map("sale_item_id")
  saleItem     SaleItem        @relation(fields: [saleItemId], references: [id])
  productId    String          @map("product_id")
  product      Product         @relation(fields: [productId], references: [id])
  variantId    String?         @map("variant_id")
  variant      ProductVariant? @relation(fields: [variantId], references: [id])
  quantity     Int
  refundAmount Decimal         @map("refund_amount") @db.Decimal(10, 2)
  createdAt    DateTime        @default(now()) @map("created_at")
}

model VariantAttribute {
  id        String   @id @default(cuid())
  clientId  String   @map("client_id")
  client    Client   @relation(fields: [clientId], references: [id])
  name      String // Attribute name: size, color, weight, etc.
  values    Json // Array of possible values: ["S", "M", "L"] or ["Red", "Blue"]
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
}
